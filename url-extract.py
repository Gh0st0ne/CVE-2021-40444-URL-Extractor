import zipfile
import sys
import magic
import re
from defang import defang

def docx():
    urls = []
    with open(sys.argv[1], 'rb') as f:
        zip = zipfile.ZipFile(f)
        xml = zip.read('word/_rels/document.xml.rels')
        
        mediapattern = re.compile(r"(?!\")(http|https):\/\/(?!(schemas\.openxmlformats\.org|microsoft\.com)).*?(?=\")", re.IGNORECASE)

        print('-'*25)
        print('\tDefanged URLs:')
        print('-'*25)
        
        for docurl in re.finditer(mediapattern, str(xml)):
            urls.append(docurl.group(0))

    for x in range(len(urls)):
        print(defang(urls[x], colon=True))


def rtf():
    with open(sys.argv[1], 'r') as f:
        text = f.read()
        pattern = re.compile(r"(http|https):\/\/(?!.*(\.microsoft\.com|\.openxmlformats\.org|purl\.org|\.w3\.org)).*?(?=})", re.IGNORECASE)
        
        print('-'*25)
        print('\tDefanged URLs:')
        print('-'*25)
        
        for url in re.finditer(pattern, text):
            print(defang(url.group(0), colon=True, all_dots=True)) 

file = magic.from_file(sys.argv[1])

if "microsoft word" in file.lower():
    docx()

if "rich text" in file.lower():
    rtf()


